{% extends 'inventario/base.html' %}

{% block title %}
  {% if producto %}Editar {{ producto.nombre }}{% else %}Crear Producto{% endif %} - Inventario CRUD
{% endblock %}

{% block header %}
  {% if producto %}Editar Producto{% else %}Crear Nuevo Producto{% endif %}
{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'inicio' %}">Inicio</a></li>
        <li class="breadcrumb-item"><a href="{% url 'producto_list' %}">Productos</a></li>
        {% if producto %}
            <li class="breadcrumb-item"><a href="{% url 'producto_detail' producto.pk %}">{{ producto.nombre }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">Editar</li>
        {% else %}
            <li class="breadcrumb-item active" aria-current="page">Crear Producto</li>
        {% endif %}
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    {% if producto %}
                        <i class="bi bi-pencil me-2"></i>Editar: {{ producto.nombre }}
                    {% else %}
                        <i class="bi bi-plus-circle me-2"></i>Nuevo Producto
                    {% endif %}
                </h5>
                {% if producto %}
                    <a href="{% url 'producto_detail' producto.pk %}" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-eye me-1"></i>Ver Detalle
                    </a>
                {% endif %}
            </div>
            <div class="card-body">
                <form method="post" class="needs-validation" novalidate>
                    {% csrf_token %}
                    
                    <!-- Campo Nombre -->
                    <div class="mb-3">
                        <label for="{{ form.nombre.id_for_label }}" class="form-label">
                            {{ form.nombre.label }} <span class="text-danger">*</span>
                        </label>
                        {{ form.nombre }}
                        {% if form.nombre.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.nombre.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        {% if form.nombre.help_text %}
                            <div class="form-text">
                                <i class="bi bi-info-circle me-1"></i>{{ form.nombre.help_text }}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Campo Precio -->
                    <div class="mb-3">
                        <label for="{{ form.precio.id_for_label }}" class="form-label">
                            {{ form.precio.label }} <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            {{ form.precio }}
                        </div>
                        {% if form.precio.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.precio.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        {% if form.precio.help_text %}
                            <div class="form-text">
                                <i class="bi bi-info-circle me-1"></i>{{ form.precio.help_text }}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Campo Descripción -->
                    <div class="mb-3">
                        <label for="{{ form.descripcion.id_for_label }}" class="form-label">
                            {{ form.descripcion.label }}
                        </label>
                        {{ form.descripcion }}
                        {% if form.descripcion.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.descripcion.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        {% if form.descripcion.help_text %}
                            <div class="form-text">
                                <i class="bi bi-info-circle me-1"></i>{{ form.descripcion.help_text }}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Campo Stock -->
                    <div class="mb-4">
                        <label for="{{ form.stock.id_for_label }}" class="form-label">
                            {{ form.stock.label }}
                        </label>
                        {{ form.stock }}
                        {% if form.stock.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.stock.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        {% if form.stock.help_text %}
                            <div class="form-text">
                                <i class="bi bi-info-circle me-1"></i>{{ form.stock.help_text }}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Información adicional (solo para edición) -->
                    {% if producto %}
                        <div class="alert alert-info" role="alert">
                            <div class="row">
                                <div class="col-md-6">
                                    <small><strong>Fecha de creación:</strong></small><br>
                                    <small class="text-muted">{{ producto.fecha_creacion|date:"d/m/Y H:i" }}</small>
                                </div>
                                <div class="col-md-6">
                                    <small><strong>Última actualización:</strong></small><br>
                                    <small class="text-muted">{{ producto.fecha_actualizacion|date:"d/m/Y H:i" }}</small>
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    <!-- Botones -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        {% if producto %}
                            <a href="{% url 'producto_detail' producto.pk %}" class="btn btn-secondary">
                                <i class="bi bi-x-circle me-1"></i>Cancelar
                            </a>
                            <button type="submit" class="btn btn-warning">
                                <i class="bi bi-check-circle me-1"></i>Actualizar Producto
                            </button>
                        {% else %}
                            <a href="{% url 'producto_list' %}" class="btn btn-secondary">
                                <i class="bi bi-x-circle me-1"></i>Cancelar
                            </a>
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-check-circle me-1"></i>Crear Producto
                            </button>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>

        <!-- Card de información sobre CSRF y formularios -->
        <div class="card mt-3">
            <div class="card-body bg-light">
                <h6 class="card-title">
                    <i class="bi bi-shield-check text-success me-2"></i>Seguridad y Formularios Django
                </h6>
                <p class="card-text small text-muted mb-2">
                    <strong>Formulario ModelForm:</strong> Este formulario utiliza Django ModelForm para 
                    validación automática y manejo seguro de datos.
                </p>
                <p class="card-text small text-muted mb-0">
                    <strong>CSRF Protection:</strong> Protección automática contra ataques Cross-Site Request Forgery 
                    mediante el token CSRF incluido en el formulario.
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Validación del formulario Bootstrap
(function() {
    'use strict';
    window.addEventListener('load', function() {
        var forms = document.getElementsByClassName('needs-validation');
        var validation = Array.prototype.filter.call(forms, function(form) {
            form.addEventListener('submit', function(event) {
                if (form.checkValidity() === false) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });
    }, false);
})();

// Prevenir valores negativos en stock
const stockField = document.getElementById('{{ form.stock.id_for_label }}');
if (stockField) {
    stockField.addEventListener('input', function(e) {
        if (e.target.value < 0) {
            e.target.value = 0;
        }
    });
}

// Formateo del precio
const priceField = document.getElementById('{{ form.precio.id_for_label }}');
if (priceField) {
    priceField.addEventListener('input', function(e) {
        let value = e.target.value;
        
        // Permitir solo números, punto decimal y eliminar caracteres no válidos
        // pero conservar la posición del cursor
        const cursorPosition = e.target.selectionStart;
        const originalLength = value.length;
        
        // Remover caracteres no válidos excepto números y un punto
        value = value.replace(/[^0-9.]/g, '');
        
        // Permitir solo un punto decimal
        const parts = value.split('.');
        if (parts.length > 2) {
            // Si hay más de un punto, mantener solo el primero
            value = parts[0] + '.' + parts.slice(1).join('');
        }
        
        // Limitar a 2 decimales después del punto
        if (parts.length === 2 && parts[1].length > 2) {
            value = parts[0] + '.' + parts[1].substring(0, 2);
        }
        
        // Actualizar el valor solo si cambió
        if (e.target.value !== value) {
            e.target.value = value;
            
            // Restaurar posición del cursor ajustando por caracteres eliminados
            const newLength = value.length;
            const lengthDiff = originalLength - newLength;
            const newPosition = Math.max(0, cursorPosition - lengthDiff);
            e.target.setSelectionRange(newPosition, newPosition);
        }
    });
    
    // Validar al salir del campo (blur)
    priceField.addEventListener('blur', function(e) {
        let value = parseFloat(e.target.value);
        if (isNaN(value) || value <= 0) {
            // Si no es un número válido o es 0 o negativo, limpiar el campo
            if (e.target.value !== '') {
                e.target.focus();
            }
        }
    });
}

{% if producto %}
// Confirmación antes de salir si hay cambios no guardados
let formChanged = false;
const form = document.querySelector('form');

form.addEventListener('input', function() {
    formChanged = true;
});

window.addEventListener('beforeunload', function(e) {
    if (formChanged) {
        const confirmationMessage = 'Tienes cambios no guardados. ¿Estás seguro de que quieres salir?';
        e.returnValue = confirmationMessage;
        return confirmationMessage;
    }
});

// Limpiar el flag cuando se envía el formulario
form.addEventListener('submit', function() {
    formChanged = false;
});
{% endif %}
</script>
{% endblock %}
